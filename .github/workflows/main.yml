
name: Download

on:
  push:
    branches: [ main]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  download-m3u:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Chrome and dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium requests

    - name: Download M3U with Selenium
      run: |
        python -c "
        from selenium import webdriver
        from selenium.webdriver.chrome.options import Options
        import time
        options = Options()
        options.add_argument('--headless')
        options.add_argument('--no-sandbox')
        options.add_argument('--disable-dev-shm-usage')
        driver = webdriver.Chrome(options=options)
        try:
        url = 'https://bc.188766.xyz/?ip=&mishitong=true&mima=mianfeibuhuaqian&json=true'
        print('正在访问:', url)
        driver.get(url)
        time.sleep(10)  
        content = driver.page_source
        print('页面加载完成')
        with open('mig2.txt', 'w', encoding='utf-8') as f:
        f.write(content)
        print('内容已保存到 mig2.txt')
        except Exception as e:
        print('错误:', e)
        finally:
        driver.quit()
        "

    - name: Commit and push changes
      run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add mig2.txt
          git diff --staged --quiet || git commit -m "自动更新：M3U文件 [skip ci]"
          git push
