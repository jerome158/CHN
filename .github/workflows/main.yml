name: Download

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  download:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install selenium

    - name: Download M3U content
      run: |
        python -c "from selenium import webdriver; from selenium.webdriver.chrome.options import Options; import time; options = Options(); options.add_argument('--headless'); options.add_argument('--no-sandbox'); options.add_argument('--disable-dev-shm-usage'); driver = webdriver.Chrome(options=options); url = 'https://bc.188766.xyz/?ip=&mishitong=true&mima=mianfeibuhuaqian&json=true'; print('æ­£åœ¨è®¿é—®:', url); driver.get(url); time.sleep(15); content = driver.page_source; print('é¡µé¢åŠ è½½å®Œæˆ'); with open('mig2.txt', 'w', encoding='utf-8') as f: f.write(content); print('å†…å®¹å·²ä¿å­˜åˆ° mig2.txt'); driver.quit()"

    - name: Verify download
      run: |
        if [ -f "mig2.txt" ]; then
          echo "âœ… ä¸‹è½½æˆåŠŸ"
          echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯:"
          echo "  å¤§å°: $(wc -c < mig2.txt) bytes"
          echo "  è¡Œæ•°: $(wc -l < mig2.txt)"
        else
          echo "âŒ ä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add mig2.txt
        git diff --staged --quiet || git commit -m "è‡ªåŠ¨æ›´æ–°M3Uå†…å®¹ [skip ci]"
        git push
