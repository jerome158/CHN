name: Convert

on:
  workflow_dispatch:
  push:
    paths:
      - 'mig2.txt'

jobs:
  debug-convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Debug conversion process
      id: debug_convert
      run: |
        echo "=== 开始调试M3U转换 ==="
        echo "当前目录内容:"
        ls -la
        
        echo -e "\n=== 检查mig2.txt文件 ==="
        if [ -f "mig2.txt" ]; then
          echo "✅ mig2.txt 文件存在"
          echo "文件详细信息:"
          file mig2.txt
          wc -l mig2.txt
          head -10 mig2.txt
        
        echo -e "\n=== 执行转换 ==="
        python C.py mig2.txt channels.txt
        
        # 检查转换结果
        if [ -f "channels.txt" ]; then
          echo "✅ 输出文件已创建"
          echo "输出文件内容预览:"
          head -10 channels.txt
        else
          echo "❌ 输出文件未创建"
        fi
    
    - name: Create debug report
      run: |
        echo "# M3U转换调试报告" > debug_report.md
        echo "" >> debug_report.md
        echo "## 文件状态" >> debug_report.md
        echo "- mig2.txt 存在: $([ -f "mig2.txt" ] && echo "是" || echo "否") >> debug_report.md
        if [ -f "channels.txt" ]; then
          echo "- 输出文件: channels.txt" >> debug_report.md
          echo "- 频道数量: $(wc -l < channels.txt)" >> debug_report.md
        fi
    
    - name: Commit results
      if: steps.debug_convert.outcome == 'success'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add debug_converter.py debug_report.md
        git commit -m "Add M3U debug tools [skip ci]" || echo "无变更可提交"
        git push
