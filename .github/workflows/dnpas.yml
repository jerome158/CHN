name: DynPass
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  getDNPass:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Generate dynamic password
      id: generate
      run: |
        import datetime
        import hashlib
        
        def generate_dynamic_password():
            base_date = datetime.datetime(2007, 11, 5)
            current_date = datetime.datetime.utcnow()
            date_diff = (current_date - base_date).days
            hash_input = str(date_diff)
            hash_object = hashlib.sha256(hash_input.encode())
            hex_dig = hash_object.hexdigest()
            middle_index = len(hex_dig) // 2
            password = hex_dig[middle_index-3:middle_index+3]
            digit_chars = [char for char in password if char.isdigit()]
            
            # 多次哈希补偿机制
            attempts = 0
            while len(digit_chars) < 6 and attempts < 10:
                additional_hash = hashlib.sha256((hash_input + str(len(digit_chars)) + str(attempts)).encode()).hexdigest()
                digit_chars.extend([char for char in additional_hash if char.isdigit()])
                attempts += 1
            
            final_password = ''.join(digit_chars[:6])
            return final_password, date_diff, current_date.strftime("%Y-%m-%d")
        
        if __name__ == "__main__":
            password, days_diff, date_str = generate_dynamic_password()
            print(f"Generated Password: {password}")
            print(f"Days since base date: {days_diff}")
            print(f"Current Date: {date_str}")

            with open("$GITHUB_OUTPUT", "a") as f:
                f.write(f"password={password}\n")
            with open("$GITHUB_ENV", "a") as f:
                f.write(f"PASSWORD={password}\n")

    - name: Create/update DYPAS.md
      run: |
        PASSWORD=${{ steps.generate.outputs.password }}
        DATE=$(date -u +"%Y-%m-%d")
        cat > DYPAS.txt << EOF
        # Dynamic Password Access System (DYPAS)
        
        ## Today's Password
        | Date | Password |
        |------|----------|
        | $DATE | $PASSWORD |
        
        ## System Information
        - Generated on: $DATE
        - Algorithm: SHA-256 with multi-hash compensation
        EOF

    - name: Commit and push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add DYPAS.txt
        git commit -m "Update DYPAS.md with new password: ${{ steps.generate.outputs.password }}" || exit 0
        git push
